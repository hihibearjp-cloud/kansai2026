<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>é—œè¥¿èƒèŸ¹ V13 æ‰¹æ¬¡åŒ¯å…¥ç‰ˆ</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- SheetJS & Tesseract -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#FF6B6B">

  <!-- App Icon (Optimized for iOS) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23FF6B6B' rx='40'/%3E%3Cpath fill='%23B71C1C' d='M30 140h10v-80h-15v-10h15c0-10 5-20 20-20h60c15 0 20 10 20 20h15v10h-15v80h10v10H30z'/%3E%3Crect x='40' y='60' width='100' height='10' fill='%23B71C1C'/%3E%3Cpath fill='%23FFCDD2' d='M40 100c-10-10-10-20 0-30 5-5 15-5 20 0l10 10 10-10c5-5 15-5 20 0 10 10 10 20 0 30-20 20-40 20-60 0z' transform='translate(10, 40)'/%3E%3Ccircle cx='65' cy='130' r='5' fill='%23333'/%3E%3Ccircle cx='115' cy='130' r='5' fill='%23333'/%3E%3Cpath fill='none' stroke='%23B71C1C' stroke-width='3' d='M70 150q20 10 40 0'/%3E%3Ccircle cx='20' cy='20' r='4' fill='white' opacity='0.8'/%3E%3Ccircle cx='150' cy='30' r='3' fill='white' opacity='0.8'/%3E%3Ccircle cx='40' cy='160' r='3' fill='white' opacity='0.8'/%3E%3Ccircle cx='160' cy='140' r='4' fill='white' opacity='0.8'/%3E%3Ccircle cx='90' cy='10' r='2' fill='white' opacity='0.8'/%3E%3C/svg%3E">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23FF6B6B' rx='40'/%3E%3Ctext x='90' y='110' font-size='80' text-anchor='middle' fill='white'%3EğŸ¦€%3C/text%3E%3C/svg%3E">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&family=Hi+Melody&display=swap');
    
    body { 
      font-family: 'Gaegu', cursive; 
      background-color: #E0F7FA; 
      -webkit-tap-highlight-color: transparent; 
      overscroll-behavior-y: none; 
      user-select: none;
      font-weight: 700;
      color: #2d3436;
    }
    
    .safe-area-top { padding-top: env(safe-area-inset-top); background-color: #FF6B6B; }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); background-color: white; }
    .korean-3d-btn { transition: all 0.1s; box-shadow: 0px 3px 0px 0px rgba(0,0,0,0.15); transform: translateY(0); }
    .korean-3d-btn:active { transform: translateY(3px); box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.15); }
    .paper-texture { background-color: #fffbf0; background-image: radial-gradient(#d4c5a6 0.8px, transparent 0.8px); background-size: 12px 12px; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    input, select, textarea { font-size: 18px !important; font-family: 'Gaegu', cursive; font-weight: 700; }
    
    .snap-x-mandatory { scroll-snap-type: x mandatory; }
    .snap-center { scroll-snap-align: center; }
    .loading-spin { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-[#E0F7FA]">
  <div id="root" class="h-full w-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- Icons ---
    const Icon = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
    );
    const Icons = {
      Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
      Trash2: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>,
      Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>,
      ShoppingBag: (p) => <Icon {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></Icon>,
      Map: (p) => <Icon {...p}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></Icon>,
      Coins: (p) => <Icon {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></Icon>,
      Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>,
      X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
      FileSpreadsheet: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></Icon>,
      Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
      Refresh: (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>,
      Camera: (p) => <Icon {...p}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></Icon>,
      Navigation: (p) => <Icon {...p}><polygon points="3 11 22 2 13 21 11 13 3 11"/></Icon>,
      Loader: (p) => <Icon {...p}><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></Icon>,
      Image: (p) => <Icon {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>,
      Suitcase: (p) => <Icon {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></Icon>,
      Calendar: (p) => <Icon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>,
      Star: (p) => <Icon {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>,
      Utensils: (p) => <Icon {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></Icon>,
      Train: (p) => <Icon {...p}><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h0"/><path d="M16 15h0"/></Icon>,
      Home: (p) => <Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>,
      ListPlus: (p) => <Icon {...p}><path d="M11 12H3"/><path d="M16 6H3"/><path d="M16 18H3"/><path d="M18 9v6"/><path d="M21 12h-6"/></Icon>,
    };

    // --- Data ---
    const INITIAL_ITINERARY = [
      { id: 1, date: '2026-02-02', weekday: 'æ—¥', content: 'å¤§é˜ª â†’ 17:00åé–€å¤§æ´‹æ¸¡è¼ª', transport: 'åé–€å¤§æ´‹æ¸¡è¼ª', stay: 'èˆ¹ä¸Š', food: 'èˆ¹ä¸Šè‡ªåŠ©é¤', highlights: 'æ¬£è³ç€¨æˆ¶å…§æµ·å¤œæ™¯', photo: null },
      { id: 2, date: '2026-02-03', weekday: 'ä¸€', content: 'é–€å¸æ¸¯ â†’ å°å€‰åŸ â†’ ç¦å²¡', transport: 'JR / æ­¥è¡Œ', stay: 'ç¦å²¡ Quintessa', food: 'ç‡’å’–å“©', highlights: 'æ‡·èˆŠå»ºç¯‰ã€å°å€‰åŸ', photo: null },
    ];
    const INITIAL_SHOPPING = [
      { id: 1, item: 'åˆåˆ©ä»–å‘½', budget: 5000, bought: false, store: 'æ¾æœ¬æ¸…', priority: 'high', type: 'self', note: '' },
    ];
    const INITIAL_PACKING_LIST = [
        { id: 1, category: 'å¿…å‚™è­‰ä»¶', item: 'è­·ç…§', checked: false },
        { id: 2, category: 'å¿…å‚™è­‰ä»¶', item: 'æ—¥å¹£ / ä¿¡ç”¨å¡', checked: false },
        { id: 3, category: 'å¿…å‚™è­‰ä»¶', item: 'VJWæˆªåœ– / æ©Ÿç¥¨', checked: false },
        { id: 4, category: 'å¿…å‚™è­‰ä»¶', item: 'ç¶²å¡ / Wifiæ©Ÿ', checked: false },
        { id: 5, category: 'è¡£ç‰©ç©¿æ­', item: 'æ›æ´—è¡£ç‰©', checked: false },
        { id: 6, category: 'è¡£ç‰©ç©¿æ­', item: 'ç¡è¡£ / å…§è¡£è¤²', checked: false },
        { id: 7, category: 'è¡£ç‰©ç©¿æ­', item: 'å¥½èµ°çš„é‹', checked: false },
        { id: 8, category: 'ç”Ÿæ´»ç”¨å“', item: 'ç‰™åˆ· / æ´—é¢ä¹³', checked: false },
        { id: 9, category: 'ç”Ÿæ´»ç”¨å“', item: 'å¸¸å‚™è—¥å“', checked: false },
        { id: 10, category: 'é›»å­ç”¢å“', item: 'å……é›»å™¨ / è¡Œå‹•é›»æº', checked: false },
    ];
    
    const INITIAL_PAYMENT_METHODS = ['ç¾é‡‘', 'ä¿¡ç”¨å¡(ä¸­ä¿¡)', 'ä¿¡ç”¨å¡(å¯Œé‚¦J)', 'è¥¿ç“œå¡'];
    const INITIAL_BOOKING_PLATFORMS = ['ç¾å ´', 'Klook', 'Kkday', 'Booking', 'Agoda', 'æ±æ©«INN'];
    const CATEGORIES = ['ğŸœ é£²é£Ÿ', 'ğŸšƒ äº¤é€š', 'ğŸ¨ ä½å®¿', 'ğŸ›ï¸ è³¼ç‰©', 'ğŸ« é–€ç¥¨', 'ğŸ“ å…¶ä»–'];
    const CURRENCIES = [
        { code: 'JPY', label: 'ğŸ‡¯ğŸ‡µ JPY', rateKey: 'JPY_TWD', symbol: 'Â¥' },
        { code: 'TWD', label: 'ğŸ‡¹ğŸ‡¼ TWD', rateKey: 'TWD_TWD', symbol: '$' },
        { code: 'USD', label: 'ğŸ‡ºğŸ‡¸ USD', rateKey: 'USD_TWD', symbol: '$' },
        { code: 'KRW', label: 'ğŸ‡°ğŸ‡· KRW', rateKey: 'KRW_TWD', symbol: 'â‚©' },
        { code: 'EUR', label: 'ğŸ‡ªğŸ‡º EUR', rateKey: 'EUR_TWD', symbol: 'â‚¬' },
    ];
    const BUTTON_COLORS = ['#FF9F43', '#4ECDC4', '#FF6B6B', '#6C5CE7', '#FFA502'];

    // --- Main App ---
    function App() {
      const loadState = (key, defaultVal) => {
        try { return JSON.parse(localStorage.getItem(key)) || defaultVal; } catch (e) { return defaultVal; }
      };

      const [activeTab, setActiveTab] = useState('itinerary');
      const [itinerary, setItinerary] = useState(() => loadState('crab_itinerary_v13', INITIAL_ITINERARY));
      const [expenses, setExpenses] = useState(() => loadState('crab_expenses_v13', []));
      const [shoppingList, setShoppingList] = useState(() => loadState('crab_shopping_v13', INITIAL_SHOPPING));
      const [packingList, setPackingList] = useState(() => loadState('crab_packing_v13', INITIAL_PACKING_LIST));
      const [paymentMethods, setPaymentMethods] = useState(() => loadState('crab_methods_v13', INITIAL_PAYMENT_METHODS));
      const [bookingPlatforms, setBookingPlatforms] = useState(() => loadState('crab_platforms_v13', INITIAL_BOOKING_PLATFORMS));
      const [budgetSettings, setBudgetSettings] = useState(() => loadState('crab_budget_v13', { 
          totalTWD: 50000, 
          startDate: '2026-02-02',
          rates: { JPY_TWD: 0.215, USD_TWD: 31.5, KRW_TWD: 0.024, EUR_TWD: 34.2, TWD_TWD: 1 } 
      }));

      // UI States
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [showExportModal, setShowExportModal] = useState(false);
      const [showBatchModal, setShowBatchModal] = useState(false);
      const [batchType, setBatchType] = useState(null); // 'shopping' or 'packing'
      const [batchText, setBatchText] = useState('');
      
      const [expenseFilter, setExpenseFilter] = useState('all');
      const [currentDayIndex, setCurrentDayIndex] = useState(0);
      const dayScrollRef = useRef(null);
      const [isScanning, setIsScanning] = useState(false);
      const [scanType, setScanType] = useState(null); 
      const fileInputRef = useRef(null);
      const [targetDayId, setTargetDayId] = useState(null);

      // Persistence
      useEffect(() => { localStorage.setItem('crab_itinerary_v13', JSON.stringify(itinerary)); }, [itinerary]);
      useEffect(() => { localStorage.setItem('crab_expenses_v13', JSON.stringify(expenses)); }, [expenses]);
      useEffect(() => { localStorage.setItem('crab_shopping_v13', JSON.stringify(shoppingList)); }, [shoppingList]);
      useEffect(() => { localStorage.setItem('crab_packing_v13', JSON.stringify(packingList)); }, [packingList]);
      useEffect(() => { localStorage.setItem('crab_methods_v13', JSON.stringify(paymentMethods)); }, [paymentMethods]);
      useEffect(() => { localStorage.setItem('crab_platforms_v13', JSON.stringify(bookingPlatforms)); }, [bookingPlatforms]);
      useEffect(() => { localStorage.setItem('crab_budget_v13', JSON.stringify(budgetSettings)); }, [budgetSettings]);

      const [newExpense, setNewExpense] = useState({ date: itinerary[0]?.date || '', item: '', amount: '', currency: 'JPY', category: 'ğŸœ é£²é£Ÿ', method: paymentMethods[0], platform: bookingPlatforms[0], note: '' });
      const [newShopItem, setNewShopItem] = useState({ item: '', budget: '', store: '', priority: 'high', type: 'self', note: '', splitCount: 1 });
      const [newPackingItem, setNewPackingItem] = useState('');

      // --- Functions ---
      const formatDate = (dateStr) => {
          if(!dateStr) return '';
          const d = new Date(dateStr);
          return `${d.getMonth()+1}/${d.getDate()}`;
      };

      const getWeekday = (dateStr) => {
          const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
          return days[new Date(dateStr).getDay()];
      };

      const updateItineraryDates = () => {
          if (!budgetSettings.startDate) return;
          const start = new Date(budgetSettings.startDate);
          const newItinerary = itinerary.map((item, index) => {
              const d = new Date(start);
              d.setDate(start.getDate() + index);
              return {
                  ...item,
                  date: d.toISOString().split('T')[0],
                  weekday: getWeekday(d.toISOString().split('T')[0])
              };
          });
          setItinerary(newItinerary);
          alert('è¡Œç¨‹æ—¥æœŸå·²å…¨éƒ¨æ›´æ–°ï¼');
      };

      const getExchangeRate = (currencyCode) => {
          return budgetSettings.rates[`${currencyCode}_TWD`] || 1;
      };

      const getDailyTotal = (date) => {
        const dailyExpenses = expenses.filter(e => e.date === date);
        const totalTWD = dailyExpenses.reduce((acc, curr) => {
            const rate = getExchangeRate(curr.currency);
            return acc + Math.round(curr.amount * rate);
        }, 0);
        return totalTWD;
      };

      const openGoogleMaps = (e, content) => {
        e.stopPropagation();
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(content)}`, '_blank');
      };
      
      const scrollToDay = (index) => {
        if (dayScrollRef.current) {
            const width = dayScrollRef.current.offsetWidth;
            dayScrollRef.current.scrollTo({ left: width * index, behavior: 'smooth' });
            setCurrentDayIndex(index);
        }
      };

      const compressImage = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > 800) { 
                        height = Math.round((height * 800) / width);
                        width = 800;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
      };

      const handleFileSelect = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setIsScanning(true);

        try {
            if (scanType === 'photo' && targetDayId) {
                const base64 = await compressImage(file);
                updateItinerary(targetDayId, 'photo', base64);
                alert('ç…§ç‰‡å·²å„²å­˜ï¼');
            } else {
                const { data: { text } } = await Tesseract.recognize(file, 'eng+jpn+chi_tra');
                if (scanType === 'itinerary' && targetDayId) {
                    const cleanedText = text.replace(/\s+/g, ' ').trim();
                    const currentContent = itinerary.find(d => d.id === targetDayId)?.content || '';
                    updateItinerary(targetDayId, 'content', currentContent + `\n${cleanedText}`);
                    alert('è¡Œç¨‹è¾¨è­˜æˆåŠŸï¼');
                } else if (scanType === 'receipt') {
                    const numbers = text.match(/\d{1,3}(,\d{3})*(\.\d+)?/g) || [];
                    const cleanNumbers = numbers.map(n => parseFloat(n.replace(/,/g, ''))).filter(n => n > 100); 
                    const maxAmount = cleanNumbers.length > 0 ? Math.max(...cleanNumbers) : '';
                    let guessedCategory = 'ğŸœ é£²é£Ÿ';
                    const lowerText = text.toLowerCase();
                    if (lowerText.includes('uniqlo') || lowerText.includes('gu')) guessedCategory = 'ğŸ›ï¸ è³¼ç‰©';
                    else if (lowerText.includes('bus') || lowerText.includes('jr')) guessedCategory = 'ğŸšƒ äº¤é€š';
                    else if (lowerText.includes('hotel')) guessedCategory = 'ğŸ¨ ä½å®¿';

                    setNewExpense(prev => ({ ...prev, amount: maxAmount || prev.amount, category: guessedCategory, note: 'OCRè‡ªå‹•è¾¨è­˜' }));
                    alert(`æ”¶æ“šè¾¨è­˜å®Œæˆï¼é‡‘é¡: ${maxAmount}`);
                }
            }
        } catch (error) { console.error(error); alert('è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦'); } 
        finally { setIsScanning(false); if(fileInputRef.current) fileInputRef.current.value = ''; setScanType(null); setTargetDayId(null); }
      };

      const triggerFileAction = (type, id = null) => { setScanType(type); setTargetDayId(id); fileInputRef.current.click(); };

      // Actions
      const addDay = () => {
        const newId = Date.now();
        let nextDate = new Date();
        if (itinerary.length > 0) {
            const lastDate = new Date(itinerary[itinerary.length - 1].date);
            lastDate.setDate(lastDate.getDate() + 1);
            nextDate = lastDate;
        } else if (budgetSettings.startDate) { nextDate = new Date(budgetSettings.startDate); }
        const dateStr = nextDate.toISOString().split('T')[0];
        const newDay = { id: newId, date: dateStr, weekday: getWeekday(dateStr), content: '', transport: '', stay: '', food: '', highlights: '', photo: null };
        setItinerary([...itinerary, newDay]);
        setTimeout(() => scrollToDay(itinerary.length), 100);
      };
      const removeDay = (id) => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä¸€å¤©å—ï¼Ÿ')) setItinerary(itinerary.filter(d => d.id !== id)); };
      const updateItinerary = (id, field, value) => { setItinerary(itinerary.map(item => item.id === id ? { ...item, [field]: value } : item)); };

      const handleAddExpense = () => {
        if (!newExpense.item || !newExpense.amount) return;
        setExpenses([...expenses, { id: Date.now(), ...newExpense, amount: parseFloat(newExpense.amount) }]);
        setNewExpense({ ...newExpense, item: '', amount: '', note: '' });
      };
      const handleDeleteExpense = (id) => { if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) setExpenses(expenses.filter(e => e.id !== id)); };

      const handleAddShoppingItem = () => {
        if (!newShopItem.item) return;
        setShoppingList([...shoppingList, { id: Date.now(), ...newShopItem, budget: parseFloat(newShopItem.budget) || 0, splitCount: parseInt(newShopItem.splitCount) || 1, bought: false }]);
        setNewShopItem({ item: '', budget: '', store: '', priority: 'high', type: 'self', note: '', splitCount: 1 });
      };
      const toggleShoppingItem = (id) => setShoppingList(shoppingList.map(item => item.id === id ? { ...item, bought: !item.bought } : item));
      const deleteShoppingItem = (id) => { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) setShoppingList(shoppingList.filter(i => i.id !== id)); };

      const togglePackingItem = (id) => setPackingList(packingList.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
      const addPackingItem = () => {
          if(!newPackingItem) return;
          setPackingList([...packingList, { id: Date.now(), category: 'ğŸ“ è‡ªè¨‚', item: newPackingItem, checked: false }]);
          setNewPackingItem('');
      };
      const deletePackingItem = (id) => setPackingList(packingList.filter(i => i.id !== id));

      // Batch Import Logic
      const handleBatchImport = () => {
          if (!batchText) return;
          const items = batchText.split('\n').filter(line => line.trim() !== '');
          if (batchType === 'shopping') {
              const newItems = items.map(line => ({
                  id: Date.now() + Math.random(),
                  item: line.trim(),
                  budget: 0, store: '', priority: 'medium', type: 'self', note: '', splitCount: 1, bought: false
              }));
              setShoppingList([...shoppingList, ...newItems]);
          } else if (batchType === 'packing') {
              const newItems = items.map(line => ({
                  id: Date.now() + Math.random(),
                  category: 'ğŸ“ è‡ªè¨‚', item: line.trim(), checked: false
              }));
              setPackingList([...packingList, ...newItems]);
          }
          setBatchText('');
          setShowBatchModal(false);
          alert(`å·²åŒ¯å…¥ ${items.length} å€‹é …ç›®ï¼`);
      };

      const fetchExchangeRate = async () => {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
            const data = await res.json();
            if(data?.rates?.TWD) {
                setBudgetSettings({ ...budgetSettings, exchangeRate: data.rates.TWD });
                alert(`åŒ¯ç‡å·²æ›´æ–°ç‚º: ${data.rates.TWD}`);
            }
        } catch(e) { alert('ç„¡æ³•æŠ“å–åŒ¯ç‡ï¼Œè«‹æ‰‹å‹•è¼¸å…¥'); }
      };

      const addMethod = (m) => { if(m && !paymentMethods.includes(m)) setPaymentMethods([...paymentMethods, m]); };
      const removeMethod = (m) => setPaymentMethods(paymentMethods.filter(i => i !== m));
      const addPlatform = (p) => { if(p && !bookingPlatforms.includes(p)) setBookingPlatforms([...bookingPlatforms, p]); };
      const removePlatform = (p) => setBookingPlatforms(bookingPlatforms.filter(i => i !== p));

      const totalSpentConvertedTWD = expenses.reduce((acc, curr) => {
          return acc + Math.round(curr.amount * getExchangeRate(curr.currency));
      }, 0);
      const remainingBudget = budgetSettings.totalTWD - totalSpentConvertedTWD;

      const shoppingStats = shoppingList.reduce((acc, item) => {
        if (item.type === 'agent') { acc.agentCount++; acc.agentTotal += item.budget; }
        else if (item.type === 'split') { acc.splitCount++; acc.splitTotal += item.budget; }
        else { acc.selfCount++; acc.selfTotal += item.budget; }
        return acc;
      }, { agentTotal: 0, agentCount: 0, selfTotal: 0, selfCount: 0, splitTotal: 0, splitCount: 0 });

      // One-Click Export
      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();
        const itineraryData = itinerary.map(d => ({ 'æ—¥æœŸ': d.date, 'æ˜ŸæœŸ': d.weekday, 'ä¸»è¦è¡Œç¨‹': d.content, 'äº¤é€š': d.transport, 'ä½å®¿': d.stay, 'äº®é»': d.highlights, 'ç¾é£Ÿ': d.food }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(shoppingList.map(s => ({ 'é¡åˆ¥': s.priority, 'é …ç›®': s.item, 'æ—¥å¹£': s.budget }))), 'æˆ°åˆ©å“');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expenses.map(e => ({ 'æ—¥æœŸ': e.date, 'é …ç›®': e.item, 'é‡‘é¡': e.amount, 'å¹£åˆ¥': e.currency }))), 'è¨˜å¸³');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(itineraryData), 'è¡Œç¨‹æ‰‹å†Š');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(packingList.map(p => ({ 'é …ç›®': p.item, 'å·²å¸¶': p.checked ? 'V' : '' }))), 'è¡Œæ');
        XLSX.writeFile(wb, `é—œè¥¿èƒèŸ¹ä¹‹æ—…_å®Œæ•´å ±è¡¨.xlsx`);
        setShowSettingsModal(false);
      };

      const SettingsModal = () => {
        const [tempMethod, setTempMethod] = useState('');
        const [tempPlatform, setTempPlatform] = useState('');
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowSettingsModal(false)}>
              <div className="bg-white w-11/12 max-w-md rounded-3xl p-6 fade-in shadow-2xl h-4/5 flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 className="font-bold text-2xl text-gray-800">âš™ï¸ è¨­å®š</h3>
                    <button onClick={() => setShowSettingsModal(false)}><Icons.X size={30}/></button>
                </div>
                <button onClick={exportToExcel} className="w-full bg-[#2E7D32] text-white font-bold text-lg py-3 rounded-xl shadow-md flex items-center justify-center gap-2 mb-4 hover:bg-[#1B5E20] transition-colors shrink-0"><Icons.FileSpreadsheet size={24}/> åŒ¯å‡º Excel å ±è¡¨</button>
                <div className="flex-1 overflow-y-auto space-y-6 no-scrollbar pb-10">
                    <div className="bg-[#E0F2F1] p-4 rounded-xl border-2 border-[#80CBC4]">
                        <h4 className="font-bold text-xl text-[#00695C] mb-3 flex items-center gap-2"><Icons.Calendar/> æ—…éŠæ—¥æœŸ</h4>
                        <div>
                            <label className="text-sm text-gray-600 font-bold ml-1">æ—…éŠé–‹å§‹æ—¥æœŸ</label>
                            <div className="flex gap-2">
                                <input type="date" value={budgetSettings.startDate} onChange={e => setBudgetSettings({...budgetSettings, startDate: e.target.value})} className="w-full p-2 rounded-lg border-2 border-[#80CBC4] outline-none font-bold text-xl text-gray-800"/>
                                <button onClick={updateItineraryDates} className="bg-[#26A69A] text-white px-3 py-1 rounded-lg font-bold text-sm shrink-0">æ›´æ–°æ—¥æœŸ</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 className="font-bold text-lg text-gray-600 mb-2">æ”¯ä»˜å·¥å…· (å¢/åˆª)</h4>
                        <div className="flex gap-2 mb-2 w-full">
                            <input value={tempMethod} onChange={e => setTempMethod(e.target.value)} placeholder="æ–°å¢..." className="flex-1 bg-gray-100 rounded-lg px-3 py-2 outline-none min-w-0" />
                            <button onClick={() => { addMethod(tempMethod); setTempMethod(''); }} className="bg-gray-800 text-white px-4 rounded-lg font-bold shrink-0 flex items-center justify-center"><Icons.Plus size={20}/></button>
                        </div>
                        <div className="flex flex-wrap gap-2">{paymentMethods.map(m => (<div key={m} className="bg-gray-50 border px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">{m} <button onClick={() => removeMethod(m)} className="text-gray-400 hover:text-red-400"><Icons.X size={14}/></button></div>))}</div>
                    </div>
                    <div>
                        <h4 className="font-bold text-lg text-gray-600 mb-2">æ”¯ä»˜å¹³å° (å¢/åˆª)</h4>
                        <div className="flex gap-2 mb-2 w-full">
                            <input value={tempPlatform} onChange={e => setTempPlatform(e.target.value)} placeholder="æ–°å¢å¹³å°..." className="flex-1 bg-gray-100 rounded-lg px-3 py-2 outline-none min-w-0" />
                            <button onClick={() => { addPlatform(tempPlatform); setTempPlatform(''); }} className="bg-[#4ECDC4] text-white px-4 rounded-lg font-bold shrink-0 flex items-center justify-center"><Icons.Plus size={20}/></button>
                        </div>
                        <div className="flex flex-wrap gap-2">{bookingPlatforms.map(p => (<div key={p} className="bg-gray-50 border px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">{p} <button onClick={() => removePlatform(p)} className="text-gray-400 hover:text-red-400"><Icons.X size={14}/></button></div>))}</div>
                    </div>
                    <div className="bg-[#FFF3E0] p-4 rounded-xl border-2 border-[#FFE0B2]">
                        <h4 className="font-bold text-xl text-[#F57C00] mb-3 flex items-center gap-2"><Icons.Coins/> åŒ¯ç‡è¨­å®š (å°å°å¹£)</h4>
                        <div className="space-y-3">
                            <div><label className="text-sm text-gray-600 font-bold ml-1">å°å¹£ç¸½é ç®—</label><div className="flex items-center bg-white rounded-lg px-2 border-2 border-[#FFE0B2]"><span className="text-gray-400 font-bold text-xl">$</span><input type="number" value={budgetSettings.totalTWD} onChange={e => setBudgetSettings({...budgetSettings, totalTWD: parseInt(e.target.value)||0})} className="w-full p-2 outline-none font-bold text-2xl text-gray-800"/></div></div>
                            <div className="grid grid-cols-2 gap-3">{CURRENCIES.filter(c => c.code !== 'TWD').map(c => (<div key={c.code}><label className="text-xs text-gray-500 font-bold">{c.label}</label><input type="number" step="0.001" value={budgetSettings.rates[`${c.code}_TWD`] || 0} onChange={e => setBudgetSettings({...budgetSettings, rates: {...budgetSettings.rates, [`${c.code}_TWD`]: parseFloat(e.target.value)||0}})} className="w-full p-2 rounded-lg border-2 border-[#FFE0B2] outline-none font-bold text-lg text-gray-800"/></div>))}</div>
                        </div>
                    </div>
                </div>
              </div>
            </div>
        );
      };

      const BatchModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowBatchModal(false)}>
            <div className="bg-white w-11/12 max-w-sm rounded-2xl p-5 fade-in" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl text-gray-800 mb-3 text-center">ğŸ“‹ æ‰¹æ¬¡åŒ¯å…¥ {batchType === 'shopping' ? 'æˆ°åˆ©å“' : 'è¡Œæ'}</h3>
                <textarea className="w-full h-40 bg-gray-50 border-2 border-gray-200 rounded-xl p-3 outline-none font-bold text-gray-700" placeholder="è²¼ä¸Šæ¸…å–®ï¼Œä¸€è¡Œä¸€é …..." value={batchText} onChange={e => setBatchText(e.target.value)}></textarea>
                <div className="flex gap-2 mt-4">
                    <button onClick={() => setShowBatchModal(false)} className="flex-1 py-3 text-gray-400 font-bold">å–æ¶ˆ</button>
                    <button onClick={handleBatchImport} className="flex-1 bg-[#4ECDC4] text-white py-3 rounded-xl font-bold korean-3d-btn">é–‹å§‹åŒ¯å…¥</button>
                </div>
            </div>
        </div>
      );

      const TabButton = ({ id, IconComp, label, bgColor, activeColor }) => (
        <button onClick={() => { setActiveTab(id); }} className={`flex flex-col items-center justify-center rounded-2xl py-1 transition-all w-full h-full ${activeTab === id ? 'shadow-inner scale-95' : 'shadow-sm'}`} style={{ backgroundColor: activeTab === id ? activeColor : bgColor, color: activeTab === id ? '#fff' : '#555' }}>
          <IconComp size={22} className="mb-0.5" /><span className="text-[10px] font-bold">{label}</span>
        </button>
      );

      return (
        <div className="flex flex-col h-full bg-white w-full max-w-4xl mx-auto shadow-2xl overflow-hidden relative font-sans text-gray-900">
          
          {isScanning && <div className="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/90 text-white"><Icons.Loader size={60} className="loading-spin mb-4 text-[#FF6B6B]" /><div className="text-3xl font-bold animate-pulse">è™•ç†ä¸­...</div></div>}
          <input type="file" accept="image/*" ref={fileInputRef} onChange={handleFileSelect} className="hidden" />
          {showSettingsModal && <SettingsModal />}
          {showExportModal && <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowExportModal(false)}><div className="bg-white w-11/12 max-w-sm rounded-2xl p-6 fade-in" onClick={e => e.stopPropagation()}><h3 className="font-bold text-2xl text-gray-800 mb-4 text-center">ğŸ“Š åŒ¯å‡º Excel</h3><button onClick={exportToExcel} className="w-full bg-[#207245] text-white font-bold text-xl py-4 rounded-xl korean-3d-btn border-2 border-black flex justify-center items-center gap-2 mb-2"><Icons.FileSpreadsheet size={24} /> ä¸‹è¼‰å ±è¡¨</button><button onClick={() => setShowExportModal(false)} className="w-full text-gray-500 font-bold py-3 text-lg">å–æ¶ˆ</button></div></div>}
          {showBatchModal && <BatchModal />}

          <div className="safe-area-top"></div>

          <div className="bg-[#FF6B6B] px-5 py-3 relative overflow-hidden border-b-4 border-black shrink-0">
            <div className="absolute top-4 right-4 z-20"><button onClick={() => setShowSettingsModal(true)} className="text-white hover:text-gray-100 bg-white/20 p-2 rounded-full"><Icons.Settings size={26} /></button></div>
            <h1 className="text-3xl font-bold text-white tracking-widest flex items-center gap-2 relative z-10 drop-shadow-[2px_2px_0_rgba(0,0,0,0.3)]"><span>ğŸ¦€</span> é—œè¥¿èƒèŸ¹ V13</h1>
            <div className="mt-2 flex items-center justify-between text-white bg-black/20 rounded-xl p-2 text-sm font-bold">
                <div className="flex gap-2 items-center"><span className="opacity-90">å‰©é¤˜</span><span className="font-bold text-xl text-[#4ECDC4] drop-shadow-md">${remainingBudget.toLocaleString()}</span></div>
                <div className="h-4 w-20 bg-black/30 rounded-full overflow-hidden border border-white/30"><div className="h-full bg-[#4ECDC4]" style={{ width: `${Math.min((totalSpentConvertedTWD / budgetSettings.totalTWD) * 100, 100)}%` }}></div></div>
                <div className="flex gap-2 items-center"><span className="opacity-90">å·²èŠ±</span><span className="font-bold text-lg">${totalSpentConvertedTWD.toLocaleString()}</span></div>
            </div>
          </div>

          <div className="flex-1 overflow-hidden relative bg-[#E0F7FA]">
            {activeTab === 'itinerary' && (
              <div className="h-full flex flex-col p-4">
                <div className="flex gap-3 overflow-x-auto no-scrollbar mb-3 shrink-0 py-1">
                  {itinerary.map((day, index) => (<button key={day.id} onClick={() => scrollToDay(index)} className={`shrink-0 w-12 h-12 rounded-full font-bold text-lg border-4 border-white shadow-md flex items-center justify-center transition-all ${currentDayIndex === index ? 'scale-110 ring-2 ring-black' : 'opacity-70'}`} style={{ backgroundColor: BUTTON_COLORS[index % BUTTON_COLORS.length], color: 'white' }}>{formatDate(day.date)}</button>))}
                  <button onClick={addDay} className="shrink-0 w-12 h-12 rounded-full bg-white border-4 border-dashed border-gray-400 flex items-center justify-center text-gray-400 hover:text-[#FF6B6B]"><Icons.Plus size={24}/></button>
                </div>
                <div ref={dayScrollRef} className="flex-1 flex overflow-x-auto snap-x-mandatory no-scrollbar gap-4 h-full" onScroll={(e) => { const index = Math.round(e.target.scrollLeft / e.target.offsetWidth); setCurrentDayIndex(index); }}>
                    {itinerary.map((day, index) => {
                        const dayTotal = getDailyTotal(day.date);
                        return (
                            <div key={day.id} className="w-full shrink-0 snap-center flex flex-col h-full">
                                <div className="bg-white border-4 border-black rounded-3xl shadow-xl flex flex-col relative h-full overflow-hidden">
                                    <div className="bg-gray-50 border-b-2 border-dashed border-gray-300 p-3 flex justify-between items-center shrink-0">
                                        <div className="flex items-center gap-2"><span className="font-black text-3xl text-gray-800">{formatDate(day.date)}</span><span className="text-xl font-bold text-gray-400">({getWeekday(day.date)})</span></div>
                                        <div className="flex gap-2"><button onClick={() => triggerFileAction('itinerary', day.id)} className="p-2 bg-[#E1BEE7] text-[#9C27B0] rounded-xl border border-black shadow active:translate-y-1"><Icons.Camera size={18}/></button><button onClick={() => removeDay(day.id)} className="p-2 bg-gray-100 text-gray-500 rounded-xl border border-gray-300 hover:text-red-500"><Icons.Trash2 size={18}/></button></div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto no-scrollbar p-4 space-y-4 paper-texture">
                                        <div className="bg-white/90 rounded-2xl p-3 border-2 border-gray-100 shadow-sm"><div className="flex items-center gap-2 text-[#0097A7] font-bold text-lg mb-2"><Icons.Map size={24}/> ä¸»è¦è¡Œç¨‹</div><textarea value={day.content} onChange={(e) => updateItinerary(day.id, 'content', e.target.value)} className="w-full bg-transparent rounded-xl p-1 text-lg font-bold text-gray-800 outline-none resize-none border-b-2 border-dashed border-gray-200 focus:border-[#4ECDC4]" rows={4} placeholder="è¼¸å…¥ä»Šæ—¥è©³ç´°è¡Œç¨‹..." /></div>
                                        <div className="flex gap-3">
                                            <div className="flex-1 bg-white/90 rounded-2xl p-2 border-2 border-gray-100 shadow-sm"><div className="flex items-center gap-1 text-[#E64A19] font-bold text-sm mb-1"><Icons.Star size={18}/> äº®é»</div><input value={day.highlights} onChange={(e) => updateItinerary(day.id, 'highlights', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="å¿…å»..." /></div>
                                            <div className="flex-1 bg-white/90 rounded-2xl p-2 border-2 border-gray-100 shadow-sm"><div className="flex items-center gap-1 text-[#F57C00] font-bold text-sm mb-1"><Icons.Utensils size={18}/> ç¾é£Ÿ</div><input value={day.food} onChange={(e) => updateItinerary(day.id, 'food', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="å¿…åƒ..." /></div>
                                        </div>
                                        <div className="flex gap-3">
                                            <div className="flex-1 bg-white/90 rounded-2xl p-2 border-2 border-gray-100 shadow-sm"><div className="flex items-center gap-1 text-[#455A64] font-bold text-sm mb-1"><Icons.Train size={18}/> äº¤é€š</div><input value={day.transport} onChange={(e) => updateItinerary(day.id, 'transport', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="æ­è»Š..." /></div>
                                            <div className="flex-1 bg-white/90 rounded-2xl p-2 border-2 border-gray-100 shadow-sm"><div className="flex items-center gap-1 text-[#5C6BC0] font-bold text-sm mb-1"><Icons.Home size={18}/> ä½å®¿</div><input value={day.stay} onChange={(e) => updateItinerary(day.id, 'stay', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="é£¯åº—..." /></div>
                                        </div>
                                        <div className="pt-1"><div className="flex items-center gap-2 text-gray-500 font-bold text-sm mb-2"><Icons.Camera size={18}/> æ‰“å¡ / ç…§ç‰‡æ—¥è¨˜</div><div onClick={() => triggerFileAction('photo', day.id)} className="w-full h-40 rounded-2xl border-4 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:bg-white/50 overflow-hidden relative bg-white/30 group transition-all">{day.photo ? <img src={day.photo} alt="Daily" className="w-full h-full object-cover" /> : <div className="flex flex-col items-center text-gray-400 group-hover:text-[#FF6B6B] transition-colors"><Icons.Image size={32}/><span className="text-xs font-bold mt-1">é»æ“Šä¸Šå‚³</span></div>}</div></div>
                                    </div>
                                    <div className="p-3 border-t-2 border-gray-100 bg-gray-50 flex justify-between items-center shrink-0"><span className="text-xs font-bold text-gray-400">èŠ±è²» ${dayTotal.toLocaleString()}</span><button onClick={(e) => openGoogleMaps(e, day.content)} className="bg-[#E0F7FA] text-[#00BCD4] px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-1 hover:bg-[#B2EBF2] border border-[#B2EBF2]"><Icons.Navigation size={16}/> å°èˆª</button></div>
                                </div>
                            </div>
                        );
                    })}
                </div>
              </div>
            )}

            {activeTab === 'expenses' && (
              <div className="h-full flex flex-col p-4 overflow-hidden">
                <div className="bg-white rounded-3xl shadow-xl border-4 border-gray-100 p-4 mb-4 shrink-0">
                    <div className="flex justify-between items-center mb-3"><h3 className="font-bold text-xl text-gray-800">ğŸ’° å¿«é€Ÿè¨˜å¸³</h3><button onClick={() => triggerFileAction('receipt')} className="bg-[#6C5CE7] text-white px-3 py-1 rounded-xl text-sm font-bold flex items-center gap-2 shadow-md active:translate-y-1"><Icons.Camera size={16}/> æ‹æ”¶æ“š</button></div>
                    <div className="space-y-2">
                      <div className="flex gap-2"><select value={newExpense.date} onChange={e => setNewExpense({...newExpense, date: e.target.value})} className="bg-gray-100 rounded-xl px-2 py-2 outline-none text-sm font-bold w-32 border-2 border-gray-200">{itinerary.map(d => <option key={d.id} value={d.date}>{formatDate(d.date)}</option>)}</select><select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})} className="bg-gray-100 rounded-xl px-2 py-2 outline-none text-sm font-bold flex-1 border-2 border-gray-200">{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                      <div className="flex gap-2"><select value={newExpense.method} onChange={e => setNewExpense({...newExpense, method: e.target.value})} className="bg-gray-100 rounded-xl px-2 py-2 outline-none text-xs font-bold flex-1 border-2 border-gray-200">{paymentMethods.map(m => <option key={m} value={m}>{m}</option>)}</select><select value={newExpense.platform} onChange={e => setNewExpense({...newExpense, platform: e.target.value})} className="bg-gray-100 rounded-xl px-2 py-2 outline-none text-xs font-bold flex-1 border-2 border-gray-200">{bookingPlatforms.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                      <input placeholder="è²·äº†ä»€éº¼ï¼Ÿ" value={newExpense.item} onChange={e => setNewExpense({...newExpense, item: e.target.value})} className="w-full text-lg font-bold border-b-4 border-dashed border-gray-300 focus:border-[#FF9F43] outline-none py-1 bg-transparent" />
                      <div className="flex gap-2">
                        <div className="flex-1 flex gap-2"><input type="number" placeholder="é‡‘é¡" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} className="w-full bg-gray-100 rounded-xl px-3 py-2 font-bold text-xl outline-none border-2 border-gray-200" /><select value={newExpense.currency} onChange={e => setNewExpense({...newExpense, currency: e.target.value})} className="bg-gray-100 rounded-xl px-1 outline-none font-bold text-sm border-2 border-gray-200 w-32">{CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.label}</option>)}</select></div>
                      </div>
                      <button onClick={handleAddExpense} className="w-full bg-[#FF9F43] text-white font-bold text-lg py-2 rounded-2xl korean-3d-btn border-2 border-black flex justify-center items-center gap-2 mt-2">âœ¨ è¨˜ä¸€ç­†</button>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto no-scrollbar pb-24">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {(expenseFilter === 'all' ? expenses : expenses.filter(e => e.date === expenseFilter)).slice().reverse().map(expense => (
                        <div key={expense.id} className="bg-white p-3 rounded-2xl border-2 border-gray-100 shadow-sm flex justify-between items-center h-20">
                        <div className="flex-1 overflow-hidden"><div className="text-xs text-gray-500 font-bold mb-1">{formatDate(expense.date)} â€¢ {expense.category}</div><div className="text-lg font-bold text-gray-900 truncate pr-2">{expense.item}</div><div className="text-xs text-gray-400 font-bold mt-1">{expense.method}</div></div>
                        <div className="text-right shrink-0"><div className="text-xl font-bold text-[#FF9F43]">{CURRENCIES.find(c => c.code === expense.currency)?.symbol}{expense.amount.toLocaleString()}</div>{expense.currency !== 'TWD' && <div className="text-xs text-gray-400 font-bold">â‰ˆ ${Math.round(expense.amount * getExchangeRate(expense.currency))}</div>}<button onClick={() => handleDeleteExpense(expense.id)} className="text-gray-300 hover:text-red-400 mt-1 p-2"><Icons.Trash2 size={16} /></button></div></div>
                    ))}
                    </div>
                </div>
              </div>
            )}

            {activeTab === 'shopping' && (
              <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar">
                <div className="flex gap-2 text-white mb-4">
                    <div className="flex-1 bg-[#FF6B81] p-3 rounded-2xl border-2 border-black shadow-md"><div className="text-sm font-bold opacity-90">ğŸ™†â€â™€ï¸ è‡ªç”¨</div><div className="font-bold text-2xl">Â¥{shoppingStats.selfTotal.toLocaleString()}</div></div>
                    <div className="flex-1 bg-[#6C5CE7] p-3 rounded-2xl border-2 border-black shadow-md"><div className="text-sm font-bold opacity-90">ğŸ“¦ ä»£è³¼æ”¶</div><div className="font-bold text-2xl text-white">${Math.round(shoppingStats.agentTotal * getExchangeRate('JPY')).toLocaleString()}</div></div>
                </div>
                <div className="bg-white p-5 rounded-3xl shadow-lg border-2 border-gray-100 mb-6">
                    <div className="flex bg-gray-100 p-1 rounded-xl mb-3 border-2 border-gray-200">
                        {['self', 'agent', 'split'].map(type => ( <button key={type} onClick={() => setNewShopItem({...newShopItem, type})} className={`flex-1 py-2 rounded-lg text-lg font-bold transition-all ${newShopItem.type === type ? 'bg-white shadow text-black' : 'text-gray-400'}`}>{type === 'self' ? 'è‡ªç”¨' : type === 'agent' ? 'ä»£è³¼' : 'åˆ†å¸³'}</button> ))}
                    </div>
                    <div className="flex gap-2 mb-2"><button onClick={() => { setBatchType('shopping'); setShowBatchModal(true); }} className="w-full bg-[#E0F2F1] text-[#00695C] py-2 rounded-xl font-bold mb-1 border-2 border-[#80CBC4] flex items-center justify-center gap-2"><Icons.ListPlus size={20}/> æ‰¹æ¬¡åŒ¯å…¥</button></div>
                    <div className="flex gap-3 mb-3">
                        <select value={newShopItem.priority} onChange={e => setNewShopItem({...newShopItem, priority: e.target.value})} className="bg-gray-50 border-2 border-gray-200 rounded-xl px-2 outline-none text-base font-bold w-32"><option value="high">ğŸ”´ å¿…è²·</option><option value="medium">ğŸŸ¡ é¸è³¼</option><option value="low">ğŸŸ¢ å¯è²·</option></select>
                        <input placeholder="æˆ°åˆ©å“åç¨±..." value={newShopItem.item} onChange={e => setNewShopItem({...newShopItem, item: e.target.value})} className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 outline-none font-bold text-xl text-gray-800" />
                    </div>
                    <div className="flex gap-3 mb-3"><input type="number" placeholder="æ—¥å¹£ Â¥" value={newShopItem.budget} onChange={e => setNewShopItem({...newShopItem, budget: e.target.value})} className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 outline-none text-xl font-bold" /></div>
                    {(newShopItem.type === 'agent' || newShopItem.type === 'split') && ( <div className="flex gap-3 mb-3 animate-in fade-in">{newShopItem.type === 'agent' && <input placeholder="å¹«èª°è²·?" value={newShopItem.note} onChange={e => setNewShopItem({...newShopItem, note: e.target.value})} className="flex-1 bg-[#EDE7F6] border-2 border-[#6C5CE7] rounded-xl px-4 py-3 outline-none text-[#6C5CE7] font-bold text-lg" />}{newShopItem.type === 'split' && <div className="flex-1 flex items-center bg-[#FFF3E0] border-2 border-[#FFA502] rounded-xl px-4 text-[#FFA502] font-bold"><span className="text-sm mr-2">äººæ•¸:</span><input type="number" value={newShopItem.splitCount} onChange={e => setNewShopItem({...newShopItem, splitCount: e.target.value})} className="w-full bg-transparent outline-none text-xl" /></div>}</div> )}
                    <button onClick={handleAddShoppingItem} className="w-full bg-[#FF6B81] text-white py-3 rounded-2xl border-2 border-black korean-3d-btn font-bold text-xl flex items-center justify-center gap-2 mt-2"><Icons.Plus size={24}/> åŠ å…¥æ¸…å–®</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {shoppingList.filter(i => !i.bought).map(item => (
                    <div key={item.id} className="bg-white p-4 rounded-2xl border-4 shadow-sm flex items-center justify-between" style={{ borderColor: item.type === 'agent' ? '#6C5CE7' : item.type === 'split' ? '#FFA502' : '#FF6B81' }}>
                        <div className="flex items-center gap-4 cursor-pointer w-full" onClick={() => toggleShoppingItem(item.id)}>
                            <div className={`w-4 h-full self-stretch rounded-full ${item.type === 'agent' ? 'bg-[#6C5CE7]' : item.type === 'split' ? 'bg-[#FFA502]' : 'bg-[#FF6B81]'}`}></div>
                            <div className="flex-1 overflow-hidden">
                                <div className="flex items-center gap-2"><span className={`text-xs px-2 py-1 rounded-lg shrink-0 text-white font-bold shadow-sm ${item.priority === 'high' ? 'bg-red-500' : item.priority === 'medium' ? 'bg-yellow-400' : 'bg-green-400'}`}>{item.priority === 'high' ? 'å¿…è²·' : item.priority === 'medium' ? 'é¸è³¼' : 'å¯è²·'}</span><span className="font-bold text-xl text-gray-800 truncate">{item.item}</span></div>
                                <div className="text-sm text-gray-500 font-bold mt-1 flex items-center gap-2"><span className="bg-gray-100 px-2 rounded">Â¥{item.budget.toLocaleString()}</span><span className="text-gray-300">âœ</span><span className="text-gray-900 font-bold text-lg">{item.type === 'split' ? `$${Math.round((item.budget * getExchangeRate('JPY')) / item.splitCount)} /äºº` : `$${Math.round(item.budget * getExchangeRate('JPY'))}`}</span></div>
                                {(item.type === 'agent' || item.type === 'split') && ( <div className="text-xs font-bold text-gray-400 mt-2 bg-gray-50 w-fit px-2 py-1 rounded">{item.type === 'agent' ? `çµ¦: ${item.note}` : `${item.splitCount}äººåˆ†å¸³`}</div> )}
                            </div>
                        </div>
                        <button onClick={() => deleteShoppingItem(item.id)} className="text-gray-300 p-2 shrink-0 hover:text-red-400"><Icons.Trash2 size={24}/></button>
                    </div>
                  ))}
                </div>
                {shoppingList.filter(i => i.bought).length > 0 && <div className="text-gray-400 text-lg font-bold mt-6 mb-3 border-b-2 border-gray-200 pb-1">å·²è³¼è²·å®Œæˆ</div>}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">{shoppingList.filter(i => i.bought).map(item => (<div key={item.id} onClick={() => toggleShoppingItem(item.id)} className="bg-gray-100 p-3 rounded-xl border-2 border-gray-200 flex items-center gap-3 opacity-60"><Icons.Check size={20} className="text-gray-500"/><span className="line-through text-gray-500 font-bold text-lg">{item.item}</span></div>))}</div>
              </div>
            )}
            
            {activeTab === 'packing' && (
                <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar">
                    <div className="bg-white p-5 rounded-3xl shadow-lg border-2 border-gray-100 mb-6">
                        <div className="flex gap-2 mb-2"><button onClick={() => { setBatchType('packing'); setShowBatchModal(true); }} className="w-full bg-[#E0F2F1] text-[#00695C] py-2 rounded-xl font-bold mb-1 border-2 border-[#80CBC4] flex items-center justify-center gap-2"><Icons.ListPlus size={20}/> æ‰¹æ¬¡åŒ¯å…¥</button></div>
                        <div className="flex gap-2"><input value={newPackingItem} onChange={e => setNewPackingItem(e.target.value)} placeholder="æ–°å¢è¡Œæç‰©å“..." className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 outline-none font-bold text-xl text-gray-800" /><button onClick={addPackingItem} className="bg-gray-800 text-white px-4 rounded-xl font-bold"><Icons.Plus size={24}/></button></div>
                    </div>
                    <div className="space-y-6">
                        {['å¿…å‚™è­‰ä»¶', 'è¡£ç‰©ç©¿æ­', 'ç”Ÿæ´»ç”¨å“', 'é›»å­ç”¢å“', 'ğŸ“ è‡ªè¨‚'].map(cat => {
                            const items = packingList.filter(i => i.category === cat || (cat === 'ğŸ“ è‡ªè¨‚' && !['å¿…å‚™è­‰ä»¶', 'è¡£ç‰©ç©¿æ­', 'ç”Ÿæ´»ç”¨å“', 'é›»å­ç”¢å“'].includes(i.category)));
                            if(items.length === 0) return null;
                            return (
                                <div key={cat}>
                                    <h3 className="font-bold text-xl text-gray-800 mb-3 ml-2 flex items-center gap-2"><span className="w-2 h-6 bg-[#FF6B6B] rounded-full"></span>{cat}</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {items.map(item => (
                                            <div key={item.id} onClick={() => togglePackingItem(item.id)} className={`p-4 rounded-2xl border-2 flex items-center justify-between transition-all cursor-pointer ${item.checked ? 'bg-gray-100 border-gray-200 opacity-60' : 'bg-white border-gray-200 shadow-sm'}`}>
                                                <div className="flex items-center gap-4"><div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center ${item.checked ? 'bg-[#4ECDC4] border-[#4ECDC4]' : 'border-gray-300'}`}>{item.checked && <Icons.Check size={16} className="text-white"/>}</div><span className={`text-xl font-bold ${item.checked ? 'line-through text-gray-400' : 'text-gray-800'}`}>{item.item}</span></div>
                                                <button onClick={(e) => { e.stopPropagation(); deletePackingItem(item.id); }} className="text-gray-300 hover:text-red-400 p-2"><Icons.Trash2 size={20}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            )}
          </div>

          <div className="bg-white border-t-2 border-gray-100 shrink-0 safe-area-bottom shadow-[0_-5px_15px_rgba(0,0,0,0.05)] grid grid-cols-4 gap-1 p-2 h-20">
            <TabButton id="itinerary" IconComp={Icons.Map} label="è¡Œç¨‹" bgColor="#FFECF2" activeColor="#FF6B81" />
            <TabButton id="expenses" IconComp={Icons.Coins} label="è¨˜å¸³" bgColor="#FFF8E1" activeColor="#FFB74D" />
            <TabButton id="shopping" IconComp={Icons.ShoppingBag} label="æˆ°åˆ©å“" bgColor="#E0F2F1" activeColor="#4DB6AC" />
            <TabButton id="packing" IconComp={Icons.Suitcase} label="è¡Œæ" bgColor="#F3E5F5" activeColor="#BA68C8" />
          </div>

        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
